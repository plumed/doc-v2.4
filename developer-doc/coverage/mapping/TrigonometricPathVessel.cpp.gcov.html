<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
<meta name="robots" content="noindex">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - plumed test coverage - mapping/TrigonometricPathVessel.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">mapping</a> - TrigonometricPathVessel.cpp<span style="font-size: 80%;"> (source / <a href="TrigonometricPathVessel.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">plumed test coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">132</td>
            <td class="headerCovTableEntry">136</td>
            <td class="headerCovTableEntryHi">97.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2020-11-18 11:20:57</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">12</td>
            <td class="headerCovTableEntry">12</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</a>
<span class="lineNum">       2 </span>            :    Copyright (c) 2016-2019 The plumed team
<span class="lineNum">       3 </span>            :    (see the PEOPLE file at the root of the distribution for a list of names)
<span class="lineNum">       4 </span>            : 
<span class="lineNum">       5 </span>            :    See http://www.plumed.org for more information.
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            :    This file is part of plumed, version 2.
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            :    plumed is free software: you can redistribute it and/or modify
<span class="lineNum">      10 </span>            :    it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      11 </span>            :    the Free Software Foundation, either version 3 of the License, or
<span class="lineNum">      12 </span>            :    (at your option) any later version.
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            :    plumed is distributed in the hope that it will be useful,
<span class="lineNum">      15 </span>            :    but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      16 </span>            :    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      17 </span>            :    GNU Lesser General Public License for more details.
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            :    You should have received a copy of the GNU Lesser General Public License
<span class="lineNum">      20 </span>            :    along with plumed.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
<span class="lineNum">      21 </span>            : +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
<span class="lineNum">      22 </span>            : #include &quot;TrigonometricPathVessel.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;vesselbase/VesselRegister.h&quot;
<span class="lineNum">      24 </span>            : 
<span class="lineNum">      25 </span>            : namespace PLMD {
<a name="26"><span class="lineNum">      26 </span>            : namespace mapping {</a>
<span class="lineNum">      27 </span>            : 
<a name="28"><span class="lineNum">      28 </span><span class="lineCov">       6455 : PLUMED_REGISTER_VESSEL(TrigonometricPathVessel,&quot;GPATH&quot;)</span></a>
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span><span class="lineCov">          3 : void TrigonometricPathVessel::registerKeywords( Keywords&amp; keys ) {</span>
<span class="lineNum">      31 </span><span class="lineCov">          3 :   StoreDataVessel::registerKeywords(keys);</span>
<a name="32"><span class="lineNum">      32 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span><span class="lineCov">       1613 : void TrigonometricPathVessel::reserveKeyword( Keywords&amp; keys ) {</span>
<span class="lineNum">      35 </span><span class="lineCov">       6452 :   keys.reserve(&quot;vessel&quot;,&quot;GPATH&quot;,&quot;calculate the position on the path using trigonometry&quot;);</span>
<span class="lineNum">      36 </span><span class="lineCov">       6452 :   keys.addOutputComponent(&quot;gspath&quot;,&quot;GPATH&quot;,&quot;the position on the path calculated using trigonometry&quot;);</span>
<span class="lineNum">      37 </span><span class="lineCov">       6452 :   keys.addOutputComponent(&quot;gzpath&quot;,&quot;GPATH&quot;,&quot;the distance from the path calculated using trigonometry&quot;);</span>
<a name="38"><span class="lineNum">      38 </span><span class="lineCov">       1613 : }</span></a>
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span><span class="lineCov">          3 : TrigonometricPathVessel::TrigonometricPathVessel( const vesselbase::VesselOptions&amp; da ):</span>
<span class="lineNum">      41 </span>            :   StoreDataVessel(da),
<span class="lineNum">      42 </span><span class="lineCov">          9 :   projdir(ReferenceConfigurationOptions(&quot;DIRECTION&quot;)),</span>
<span class="lineNum">      43 </span><span class="lineCov">          6 :   mydpack1( 1, getAction()-&gt;getNumberOfDerivatives() ),</span>
<span class="lineNum">      44 </span><span class="lineCov">          6 :   mydpack2( 1, getAction()-&gt;getNumberOfDerivatives() ),</span>
<span class="lineNum">      45 </span><span class="lineCov">          6 :   mydpack3( 1, getAction()-&gt;getNumberOfDerivatives() ),</span>
<span class="lineNum">      46 </span>            :   mypack1( 0, 0, mydpack1 ),
<span class="lineNum">      47 </span>            :   mypack2( 0, 0, mydpack2 ),
<span class="lineNum">      48 </span><span class="lineCov">         36 :   mypack3( 0, 0, mydpack3 )</span>
<span class="lineNum">      49 </span>            : {
<span class="lineNum">      50 </span><span class="lineCov">          3 :   mymap=dynamic_cast&lt;Mapping*&gt;( getAction() );</span>
<span class="lineNum">      51 </span><span class="lineCov">          3 :   plumed_massert( mymap, &quot;Trigonometric path vessel can only be used with mappings&quot;);</span>
<span class="lineNum">      52 </span>            :   // Retrieve the index of the property in the underlying mapping
<span class="lineNum">      53 </span><span class="lineCov">          3 :   if( mymap-&gt;getNumberOfProperties()!=1 ) error(&quot;cannot use trigonometric paths when there are multiple properties&quot;);</span>
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span><span class="lineCov">        372 :   for(unsigned i=0; i&lt;mymap-&gt;getFullNumberOfTasks(); ++i) {</span>
<span class="lineNum">      56 </span><span class="lineCov">        122 :     if( mymap-&gt;getTaskCode(i)!=mymap-&gt;getPositionInFullTaskList(i) ) error(&quot;mismatched tasks and codes&quot;);</span>
<span class="lineNum">      57 </span>            :   }
<span class="lineNum">      58 </span><span class="lineCov">          9 :   mymap-&gt;addComponentWithDerivatives(&quot;gspath&quot;); mymap-&gt;componentIsNotPeriodic(&quot;gspath&quot;);</span>
<span class="lineNum">      59 </span><span class="lineCov">          6 :   sp=mymap-&gt;copyOutput( mymap-&gt;getNumberOfComponents()-1 ); sp-&gt;resizeDerivatives( mymap-&gt;getNumberOfDerivatives() );</span>
<span class="lineNum">      60 </span><span class="lineCov">          9 :   mymap-&gt;addComponentWithDerivatives(&quot;gzpath&quot;); mymap-&gt;componentIsNotPeriodic(&quot;gzpath&quot;);</span>
<span class="lineNum">      61 </span><span class="lineCov">          6 :   zp=mymap-&gt;copyOutput( mymap-&gt;getNumberOfComponents()-1 ); zp-&gt;resizeDerivatives( mymap-&gt;getNumberOfDerivatives() );</span>
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span>            :   // Check we have PCA
<span class="lineNum">      64 </span><span class="lineCov">          3 :   ReferenceConfiguration* ref0=mymap-&gt;getReferenceConfiguration(0);</span>
<span class="lineNum">      65 </span><span class="lineCov">        250 :   for(unsigned i=0; i&lt;mymap-&gt;getFullNumberOfTasks(); ++i) {</span>
<span class="lineNum">      66 </span><span class="lineCov">        122 :     if( !(mymap-&gt;getReferenceConfiguration(i))-&gt;pcaIsEnabledForThisReference() ) error(&quot;pca must be implemented in order to use trigometric path&quot;);</span>
<span class="lineNum">      67 </span><span class="lineCov">        366 :     if( ref0-&gt;getName()!=(mymap-&gt;getReferenceConfiguration(i))-&gt;getName() ) error(&quot;cannot use mixed metrics&quot;);</span>
<span class="lineNum">      68 </span><span class="lineCov">        244 :     if( mymap-&gt;getNumberOfAtoms()!=(mymap-&gt;getReferenceConfiguration(i))-&gt;getNumberOfReferencePositions() ) error(&quot;all frames must use the same set of atoms&quot;);</span>
<span class="lineNum">      69 </span><span class="lineCov">        122 :     if( mymap-&gt;getNumberOfArguments()!=(mymap-&gt;getReferenceConfiguration(i))-&gt;getNumberOfReferenceArguments() ) error(&quot;all frames must use the same set of arguments&quot;);</span>
<span class="lineNum">      70 </span>            :   }
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span><span class="lineCov">          6 :   cargs.resize( mymap-&gt;getNumberOfArguments() ); std::vector&lt;std::string&gt; argument_names( mymap-&gt;getNumberOfArguments() );</span>
<span class="lineNum">      73 </span><span class="lineCov">         11 :   for(unsigned i=0; i&lt;mymap-&gt;getNumberOfArguments(); ++i) argument_names[i] = (mymap-&gt;getPntrToArgument(i))-&gt;getName();</span>
<span class="lineNum">      74 </span><span class="lineCov">          3 :   projdir.setNamesAndAtomNumbers( mymap-&gt;getAbsoluteIndexes(), argument_names );</span>
<span class="lineNum">      75 </span><span class="lineCov">          6 :   mypack1.resize( mymap-&gt;getNumberOfArguments(), mymap-&gt;getNumberOfAtoms() ); ref0-&gt;setupPCAStorage( mypack1 );</span>
<span class="lineNum">      76 </span><span class="lineCov">          6 :   mypack2.resize( mymap-&gt;getNumberOfArguments(), mymap-&gt;getNumberOfAtoms() ); ref0-&gt;setupPCAStorage( mypack2 );</span>
<span class="lineNum">      77 </span><span class="lineCov">          6 :   mypack3.resize( mymap-&gt;getNumberOfArguments(), mymap-&gt;getNumberOfAtoms() );</span>
<span class="lineNum">      78 </span><span class="lineCov">         45 :   for(unsigned i=0; i&lt;mymap-&gt;getNumberOfAtoms(); ++i) { mypack1.setAtomIndex(i,i); mypack2.setAtomIndex(i,i); mypack3.setAtomIndex(i,i); }</span>
<span class="lineNum">      79 </span><span class="lineCov">          3 :   mypack1_stashd_atoms.resize( mymap-&gt;getNumberOfAtoms() ); mypack1_stashd_args.resize( mymap-&gt;getNumberOfArguments() );</span>
<a name="80"><span class="lineNum">      80 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span><span class="lineCov">          3 : std::string TrigonometricPathVessel::description() {</span>
<span class="lineNum">      83 </span><span class="lineCov">          3 :   return &quot;values gspath and gzpath contain the position on and distance from the path calculated using trigonometry&quot;;</span>
<a name="84"><span class="lineNum">      84 </span>            : }</a>
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span><span class="lineCov">          7 : void TrigonometricPathVessel::resize() {</span>
<span class="lineNum">      87 </span><span class="lineCov">          7 :   StoreDataVessel::resize();</span>
<span class="lineNum">      88 </span><span class="lineCov">          7 :   if( getAction()-&gt;derivativesAreRequired() ) {</span>
<span class="lineNum">      89 </span><span class="lineCov">          4 :     unsigned nderivatives=getAction()-&gt;getNumberOfDerivatives();</span>
<span class="lineNum">      90 </span><span class="lineCov">          8 :     sp-&gt;resizeDerivatives( nderivatives ); zp-&gt;resizeDerivatives( nderivatives );</span>
<span class="lineNum">      91 </span>            :   }
<a name="92"><span class="lineNum">      92 </span><span class="lineCov">          7 : }</span></a>
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span><span class="lineCov">       1193 : void TrigonometricPathVessel::finish( const std::vector&lt;double&gt;&amp; buffer ) {</span>
<span class="lineNum">      95 </span>            :   // Store the data calculated during mpi loop
<span class="lineNum">      96 </span><span class="lineCov">       1193 :   StoreDataVessel::finish( buffer );</span>
<span class="lineNum">      97 </span>            :   // Get current value of all arguments
<span class="lineNum">      98 </span><span class="lineCov">       6268 :   for(unsigned i=0; i&lt;cargs.size(); ++i) cargs[i]=mymap-&gt;getArgument(i);</span>
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            :   // Determine closest and second closest point to current position
<span class="lineNum">     101 </span><span class="lineCov">       1193 :   double lambda=mymap-&gt;getLambda();</span>
<span class="lineNum">     102 </span><span class="lineCov">       2386 :   std::vector&lt;double&gt; dist( getNumberOfComponents() ), dist2( getNumberOfComponents() );;</span>
<span class="lineNum">     103 </span><span class="lineCov">       1193 :   retrieveSequentialValue( 0, false, dist );</span>
<span class="lineNum">     104 </span><span class="lineCov">       1193 :   retrieveSequentialValue( 1, false, dist2 );</span>
<span class="lineNum">     105 </span><span class="lineCov">       1193 :   iclose1=getStoreIndex(0); iclose2=getStoreIndex(1);</span>
<span class="lineNum">     106 </span><span class="lineCov">       2386 :   double mindist1=dist[0], mindist2=dist2[0];</span>
<span class="lineNum">     107 </span><span class="lineCov">       1193 :   if( lambda&gt;0.0 ) {</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :     mindist1=-std::log( dist[0] ) / lambda;</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :     mindist2=-std::log( dist2[0] ) / lambda;</span>
<span class="lineNum">     110 </span>            :   }
<span class="lineNum">     111 </span><span class="lineCov">       1193 :   if( mindist2&lt;mindist1 ) {</span>
<span class="lineNum">     112 </span>            :     double tmp=mindist1; mindist1=mindist2; mindist2=tmp;
<span class="lineNum">     113 </span><span class="lineCov">        866 :     iclose1=getStoreIndex(1); iclose2=getStoreIndex(0);</span>
<span class="lineNum">     114 </span>            :   }
<span class="lineNum">     115 </span><span class="lineCov">      56519 :   for(unsigned i=2; i&lt;getNumberOfStoredValues(); ++i) {</span>
<span class="lineNum">     116 </span><span class="lineCov">      55326 :     retrieveSequentialValue( i, false, dist );</span>
<span class="lineNum">     117 </span><span class="lineCov">      55326 :     double ndist=dist[0];</span>
<span class="lineNum">     118 </span><span class="lineCov">      55326 :     if( lambda&gt;0.0 ) ndist=-std::log( dist[0] ) / lambda;</span>
<span class="lineNum">     119 </span><span class="lineCov">      55326 :     if( ndist&lt;mindist1 ) {</span>
<span class="lineNum">     120 </span><span class="lineCov">      19737 :       mindist2=mindist1; iclose2=iclose1;</span>
<span class="lineNum">     121 </span><span class="lineCov">      19737 :       mindist1=ndist; iclose1=getStoreIndex(i);</span>
<span class="lineNum">     122 </span><span class="lineCov">      35589 :     } else if( ndist&lt;mindist2 ) {</span>
<span class="lineNum">     123 </span><span class="lineCov">       1062 :       mindist2=ndist; iclose2=getStoreIndex(i);</span>
<span class="lineNum">     124 </span>            :     }
<span class="lineNum">     125 </span>            :   }
<span class="lineNum">     126 </span>            :   // And find third closest point
<span class="lineNum">     127 </span><span class="lineCov">       1193 :   int isign = iclose1 - iclose2;</span>
<span class="lineNum">     128 </span><span class="lineCov">       1193 :   if( isign&gt;1 ) isign=1; else if( isign&lt;-1 ) isign=-1;</span>
<span class="lineNum">     129 </span><span class="lineCov">       1193 :   int iclose3 = iclose1 + isign; double v2v2;</span>
<span class="lineNum">     130 </span>            :   // We now have to compute vectors connecting the three closest points to the
<span class="lineNum">     131 </span>            :   // new point
<span class="lineNum">     132 </span><span class="lineCov">       2386 :   double v1v1 = (mymap-&gt;getReferenceConfiguration( iclose1 ))-&gt;calculate( mymap-&gt;getPositions(), mymap-&gt;getPbc(), mymap-&gt;getArguments(), mypack1, true );</span>
<span class="lineNum">     133 </span><span class="lineCov">       2386 :   double v3v3 = (mymap-&gt;getReferenceConfiguration( iclose2 ))-&gt;calculate( mymap-&gt;getPositions(), mymap-&gt;getPbc(), mymap-&gt;getArguments(), mypack3, true );</span>
<span class="lineNum">     134 </span><span class="lineCov">       2369 :   if( iclose3&lt;0 || iclose3&gt;=mymap-&gt;getFullNumberOfTasks() ) {</span>
<span class="lineNum">     135 </span><span class="lineCov">         31 :     ReferenceConfiguration* conf2=mymap-&gt;getReferenceConfiguration( iclose1 );</span>
<span class="lineNum">     136 </span><span class="lineCov">        124 :     v2v2=(mymap-&gt;getReferenceConfiguration( iclose2 ))-&gt;calc( conf2-&gt;getReferencePositions(), mymap-&gt;getPbc(), mymap-&gt;getArguments(),</span>
<span class="lineNum">     137 </span><span class="lineCov">         62 :          conf2-&gt;getReferenceArguments(), mypack2, true );</span>
<span class="lineNum">     138 </span><span class="lineCov">         93 :     (mymap-&gt;getReferenceConfiguration( iclose2 ))-&gt;extractDisplacementVector( conf2-&gt;getReferencePositions(), mymap-&gt;getArguments(),</span>
<span class="lineNum">     139 </span><span class="lineCov">         31 :         conf2-&gt;getReferenceArguments(), false, projdir );</span>
<span class="lineNum">     140 </span>            :   } else {
<span class="lineNum">     141 </span><span class="lineCov">       2324 :     ReferenceConfiguration* conf2=mymap-&gt;getReferenceConfiguration( iclose3 );</span>
<span class="lineNum">     142 </span><span class="lineCov">       4648 :     v2v2=(mymap-&gt;getReferenceConfiguration( iclose1 ))-&gt;calc( conf2-&gt;getReferencePositions(), mymap-&gt;getPbc(), mymap-&gt;getArguments(),</span>
<span class="lineNum">     143 </span><span class="lineCov">       2324 :          conf2-&gt;getReferenceArguments(), mypack2, true );</span>
<span class="lineNum">     144 </span><span class="lineCov">       3486 :     (mymap-&gt;getReferenceConfiguration( iclose1 ))-&gt;extractDisplacementVector( conf2-&gt;getReferencePositions(), mymap-&gt;getArguments(),</span>
<span class="lineNum">     145 </span><span class="lineCov">       1162 :         conf2-&gt;getReferenceArguments(), false, projdir );</span>
<span class="lineNum">     146 </span>            :   }
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            :   // Stash derivatives of v1v1
<span class="lineNum">     149 </span><span class="lineCov">       3781 :   for(unsigned i=0; i&lt;mymap-&gt;getNumberOfArguments(); ++i) mypack1_stashd_args[i]=mypack1.getArgumentDerivative(i);</span>
<span class="lineNum">     150 </span><span class="lineCov">       2386 :   if( mymap-&gt;getNumberOfAtoms()&gt;0 ) {</span>
<span class="lineNum">     151 </span><span class="lineCov">        546 :     ReferenceAtoms* at = dynamic_cast&lt;ReferenceAtoms*&gt;( mymap-&gt;getReferenceConfiguration( iclose1 ) );</span>
<span class="lineNum">     152 </span>            :     const std::vector&lt;double&gt; &amp; displace( at-&gt;getDisplace() );
<span class="lineNum">     153 </span><span class="lineCov">      15288 :     for(unsigned i=0; i&lt;mymap-&gt;getNumberOfAtoms(); ++i) {</span>
<span class="lineNum">     154 </span><span class="lineCov">      28392 :       mypack1_stashd_atoms[i]=mypack1.getAtomDerivative(i); mypack1.getAtomsDisplacementVector()[i] /= displace[i];</span>
<span class="lineNum">     155 </span>            :     }
<span class="lineNum">     156 </span>            :   }
<span class="lineNum">     157 </span>            :   // Calculate the dot product of v1 with v2
<span class="lineNum">     158 </span><span class="lineCov">       2386 :   double v1v2 = (mymap-&gt;getReferenceConfiguration(iclose1))-&gt;projectDisplacementOnVector( projdir, mymap-&gt;getArguments(), cargs, mypack1 );</span>
<span class="lineNum">     159 </span>            : 
<span class="lineNum">     160 </span>            :   // This computes s value
<span class="lineNum">     161 </span><span class="lineCov">       2386 :   double spacing = mymap-&gt;getPropertyValue( iclose1, 0 ) - mymap-&gt;getPropertyValue( iclose2, 0 );</span>
<span class="lineNum">     162 </span><span class="lineCov">       1193 :   double root = sqrt( v1v2*v1v2 - v2v2 * ( v1v1 - v3v3) );</span>
<span class="lineNum">     163 </span><span class="lineCov">       1193 :   dx = 0.5 * ( (root + v1v2) / v2v2 - 1.);</span>
<span class="lineNum">     164 </span><span class="lineCov">       2386 :   double path_s = mymap-&gt;getPropertyValue(iclose1, 0) + spacing * dx; sp-&gt;set( path_s );</span>
<span class="lineNum">     165 </span><span class="lineCov">       1193 :   double fact = 0.25*spacing / v2v2;</span>
<span class="lineNum">     166 </span>            :   // Derivative of s wrt arguments
<span class="lineNum">     167 </span><span class="lineCov">       3781 :   for(unsigned i=0; i&lt;mymap-&gt;getNumberOfArguments(); ++i) {</span>
<span class="lineNum">     168 </span><span class="lineCov">       5176 :     sp-&gt;setDerivative( i, fact*( mypack2.getArgumentDerivative(i) + (v2v2 * (-mypack1_stashd_args[i] + mypack3.getArgumentDerivative(i))</span>
<span class="lineNum">     169 </span><span class="lineCov">       1294 :                                  + v1v2*mypack2.getArgumentDerivative(i) )/root ) );</span>
<span class="lineNum">     170 </span>            :   }
<span class="lineNum">     171 </span>            :   // Derivative of s wrt atoms
<span class="lineNum">     172 </span><span class="lineCov">       1193 :   unsigned narg=mymap-&gt;getNumberOfArguments(); Tensor vir; vir.zero(); fact = 0.5*spacing / v2v2;</span>
<span class="lineNum">     173 </span><span class="lineCov">       2386 :   if( mymap-&gt;getNumberOfAtoms()&gt;0 ) {</span>
<span class="lineNum">     174 </span><span class="lineCov">      15288 :     for(unsigned i=0; i&lt;mymap-&gt;getNumberOfAtoms(); ++i) {</span>
<span class="lineNum">     175 </span><span class="lineCov">      14196 :       Vector ader = fact*(( v1v2*mypack1.getAtomDerivative(i) + 0.5*v2v2*(-mypack1_stashd_atoms[i] + mypack3.getAtomDerivative(i) ) )/root + mypack1.getAtomDerivative(i) );</span>
<span class="lineNum">     176 </span><span class="lineCov">      49686 :       for(unsigned k=0; k&lt;3; ++k) sp-&gt;setDerivative( narg+3*i+k, ader[k] );</span>
<span class="lineNum">     177 </span><span class="lineCov">      14196 :       vir-=Tensor( mymap-&gt;getPosition(i), ader );</span>
<span class="lineNum">     178 </span>            :     }
<span class="lineNum">     179 </span>            :     // Set the virial
<span class="lineNum">     180 </span><span class="lineCov">        546 :     unsigned nbase=narg+3*mymap-&gt;getNumberOfAtoms();</span>
<span class="lineNum">     181 </span><span class="lineCov">       7098 :     for(unsigned i=0; i&lt;3; ++i) for(unsigned j=0; j&lt;3; ++j) sp-&gt;setDerivative( nbase+3*i+j, vir(i,j) );</span>
<span class="lineNum">     182 </span>            :   }
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span>            :   // Now compute z value
<span class="lineNum">     185 </span><span class="lineCov">       1193 :   ReferenceConfiguration* conf2=mymap-&gt;getReferenceConfiguration( iclose1 );</span>
<span class="lineNum">     186 </span><span class="lineCov">       5965 :   double v4v4=(mymap-&gt;getReferenceConfiguration( iclose2 ))-&gt;calc( conf2-&gt;getReferencePositions(), mymap-&gt;getPbc(), mymap-&gt;getArguments(),</span>
<span class="lineNum">     187 </span><span class="lineCov">       3579 :               conf2-&gt;getReferenceArguments(), mypack2, true );</span>
<span class="lineNum">     188 </span>            :   // Extract vector connecting frames
<span class="lineNum">     189 </span><span class="lineCov">       3579 :   (mymap-&gt;getReferenceConfiguration( iclose2 ))-&gt;extractDisplacementVector( conf2-&gt;getReferencePositions(), mymap-&gt;getArguments(),</span>
<span class="lineNum">     190 </span><span class="lineCov">       1193 :       conf2-&gt;getReferenceArguments(), false, projdir );</span>
<span class="lineNum">     191 </span>            :   // Calculate projection of vector on line connnecting frames
<span class="lineNum">     192 </span><span class="lineCov">       2386 :   double proj = (mymap-&gt;getReferenceConfiguration(iclose1))-&gt;projectDisplacementOnVector( projdir, mymap-&gt;getArguments(), cargs, mypack1 );</span>
<span class="lineNum">     193 </span><span class="lineCov">       1193 :   double path_z = v1v1 + dx*dx*v4v4 - 2*dx*proj;</span>
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span>            :   // Derivatives for z path
<span class="lineNum">     196 </span><span class="lineCov">       2386 :   path_z = sqrt(path_z); zp-&gt;set( path_z ); vir.zero();</span>
<span class="lineNum">     197 </span><span class="lineCov">       6369 :   for(unsigned i=0; i&lt;mymap-&gt;getNumberOfArguments(); ++i) zp-&gt;setDerivative( i, (mypack1_stashd_args[i] - 2*dx*mypack1.getArgumentDerivative(i))/(2.0*path_z) );</span>
<span class="lineNum">     198 </span>            :   // Derivative wrt atoms
<span class="lineNum">     199 </span><span class="lineCov">       2386 :   if( mymap-&gt;getNumberOfAtoms()&gt;0 ) {</span>
<span class="lineNum">     200 </span><span class="lineCov">      15288 :     for(unsigned i=0; i&lt;mymap-&gt;getNumberOfAtoms(); ++i) {</span>
<span class="lineNum">     201 </span><span class="lineCov">      28392 :       Vector dxder; for(unsigned k=0; k&lt;3; ++k) dxder[k] = ( 2*v4v4*dx - 2*proj )*spacing*sp-&gt;getDerivative( narg + 3*i+k );</span>
<span class="lineNum">     202 </span><span class="lineCov">      14196 :       Vector ader = ( mypack1_stashd_atoms[i] - 2.*dx*mypack1.getAtomDerivative(i) + dxder )/ (2.0*path_z);</span>
<span class="lineNum">     203 </span><span class="lineCov">      49686 :       for(unsigned k=0; k&lt;3; ++k) zp-&gt;setDerivative( narg+3*i+k, ader[k] );</span>
<span class="lineNum">     204 </span><span class="lineCov">      14196 :       vir-=Tensor( mymap-&gt;getPosition(i), ader );</span>
<span class="lineNum">     205 </span>            :     }
<span class="lineNum">     206 </span>            :     // Set the virial
<span class="lineNum">     207 </span><span class="lineCov">        546 :     unsigned nbase=narg+3*mymap-&gt;getNumberOfAtoms();</span>
<span class="lineNum">     208 </span><span class="lineCov">       7098 :     for(unsigned i=0; i&lt;3; ++i) for(unsigned j=0; j&lt;3; ++j) zp-&gt;setDerivative( nbase+3*i+j, vir(i,j) );</span>
<span class="lineNum">     209 </span>            :   }
<a name="210"><span class="lineNum">     210 </span><span class="lineCov">       1193 : }</span></a>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineCov">       1193 : bool TrigonometricPathVessel::applyForce( std::vector&lt;double&gt;&amp; forces ) {</span>
<span class="lineNum">     213 </span><span class="lineCov">       2386 :   std::vector&lt;double&gt; tmpforce( forces.size(), 0.0 );</span>
<span class="lineNum">     214 </span><span class="lineCov">       2386 :   forces.assign(forces.size(),0.0); bool wasforced=false;</span>
<span class="lineNum">     215 </span><span class="lineCov">       1193 :   if( sp-&gt;applyForce( tmpforce ) ) {</span>
<span class="lineNum">     216 </span>            :     wasforced=true;
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :     for(unsigned j=0; j&lt;forces.size(); ++j) forces[j]+=tmpforce[j];</span>
<span class="lineNum">     218 </span>            :   }
<span class="lineNum">     219 </span><span class="lineCov">       2386 :   tmpforce.assign(forces.size(),0.0);</span>
<span class="lineNum">     220 </span><span class="lineCov">       1193 :   if( zp-&gt;applyForce( tmpforce ) ) {</span>
<span class="lineNum">     221 </span>            :     wasforced=true;
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :     for(unsigned j=0; j&lt;forces.size(); ++j) forces[j]+=tmpforce[j];</span>
<span class="lineNum">     223 </span>            :   }
<span class="lineNum">     224 </span><span class="lineCov">       1193 :   return wasforced;</span>
<span class="lineNum">     225 </span>            : }
<a name="226"><span class="lineNum">     226 </span>            : </a>
<span class="lineNum">     227 </span>            : }
<span class="lineNum">     228 </span><span class="lineCov">       4839 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
