<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>PLUMED: Trieste tutorial: Metadynamics simulations with PLUMED</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.4.8</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('trieste-4.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Trieste tutorial: Metadynamics simulations with PLUMED </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="trieste-4-aims"></a>
Aims</h1>
<p>The aim of this tutorial is to train users to perform metadynamics simulations with PLUMED, analyze the results, calculating free-energies as a function of the collective variables used, and estimating the associated error.</p>
<h1><a class="anchor" id="trieste-4-objectives"></a>
Objectives</h1>
<p>Once this tutorial is completed students will be able to:</p><ul>
<li>Write the PLUMED input file to perform metadynamics simulations</li>
<li>Calculate the free energy from a metadynamics run</li>
<li>Compute the error associated to the reconstructed free energy</li>
<li>Evaluate the convergence of a metadynamics simulation</li>
<li>Assess the choice of the collective variables</li>
</ul>
<h1><a class="anchor" id="trieste-4-resources"></a>
Resources</h1>
<p>The <span style="background-color:yellow"><a href="tutorial-resources/trieste-4.tar.gz" style="font-weight:bold" style="color:green" download="trieste-4.tar.gz">TARBALL </a> </span> for this project contains the following files:</p><ul>
<li>diala.pdb: a PDB file for alanine dipeptide in vacuo</li>
<li>topol.tpr: a GROMACS run file to perform MD of alanine dipeptide</li>
<li>do_block_fes.py: a python script to perform error analysis</li>
</ul>
<p>This tutorial has been tested on a pre-release version of version 2.4. However, it should not take advantage of 2.4-only features, thus should also work with version 2.3.</p>
<dl class="section note"><dt>Note</dt><dd>We suggest to run the three exercises in three separate directories. For Exercise 3, you will need the output of the first two exercizes, so don't delete it!</dd></dl>
<h1><a class="anchor" id="trieste-4-intro"></a>
Introduction</h1>
<p>We have seen that PLUMED can be used to compute collective variables. However, PLUMED is most often use to add forces on the collective variables. To this aim, we have implemented a variety of possible biases acting on collective variables. The complete documentation for all the biasing methods available in PLUMED can be found at the <a class="el" href="_bias.html">Bias</a> page. In the following we will see how to build an adaptive bias potential with metadynamics. Here you can find a brief recap of the metadynamics theory.</p>
<p> <details> <summary> <b> To learn more: Summary of theory </b> </summary> <div class="hidden"> </p>
<p>In metadynamics, an external history-dependent bias potential is constructed in the space of a few selected degrees of freedom \( \vec{s}({q}) \), generally called collective variables (CVs) <a class="el" href="citelist.html#CITEREF_metad">[57]</a>. This potential is built as a sum of Gaussians deposited along the trajectory in the CVs space:</p>
<p class="formulaDsp">
\[ V(\vec{s},t) = \sum_{ k \tau &lt; t} W(k \tau) \exp\left( -\sum_{i=1}^{d} \frac{(s_i-s_i({q}(k \tau)))^2}{2\sigma_i^2} \right). \]
</p>
<p>where \( \tau \) is the Gaussian deposition stride, \( \sigma_i \) the width of the Gaussian for the ith CV, and \( W(k \tau) \) the height of the Gaussian. The effect of the metadynamics bias potential is to push the system away from local minima into visiting new regions of the phase space. Furthermore, in the long time limit, the bias potential converges to minus the free energy as a function of the CVs:</p>
<p class="formulaDsp">
\[ V(\vec{s},t\rightarrow \infty) = -F(\vec{s}) + C. \]
</p>
<p>In standard metadynamics, Gaussians of constant height are added for the entire course of a simulation. As a result, the system is eventually pushed to explore high free-energy regions and the estimate of the free energy calculated from the bias potential oscillates around the real value. In well-tempered metadynamics <a class="el" href="citelist.html#CITEREF_Barducci:2008">[7]</a>, the height of the Gaussian is decreased with simulation time according to:</p>
<p class="formulaDsp">
\[ W (k \tau ) = W_0 \exp \left( -\frac{V(\vec{s}({q}(k \tau)),k \tau)}{k_B\Delta T} \right ), \]
</p>
<p>where \( W_0 \) is an initial Gaussian height, \( \Delta T \) an input parameter with the dimension of a temperature, and \( k_B \) the Boltzmann constant. With this rescaling of the Gaussian height, the bias potential smoothly converges in the long time limit, but it does not fully compensate the underlying free energy:</p>
<p class="formulaDsp">
\[ V(\vec{s},t\rightarrow \infty) = -\frac{\Delta T}{T+\Delta T}F(\vec{s}) + C. \]
</p>
<p>where \( T \) is the temperature of the system. In the long time limit, the CVs thus sample an ensemble at a temperature \( T+\Delta T \) which is higher than the system temperature \( T \). The parameter \( \Delta T \) can be chosen to regulate the extent of free-energy exploration: \( \Delta T = 0\) corresponds to standard MD, \( \Delta T \rightarrow \infty \) to standard metadynamics. In well-tempered metadynamics literature and in PLUMED, you will often encounter the term "biasfactor" which is the ratio between the temperature of the CVs ( \( T+\Delta T \)) and the system temperature ( \( T \)):</p>
<p class="formulaDsp">
\[ \gamma = \frac{T+\Delta T}{T}. \]
</p>
<p>The biasfactor should thus be carefully chosen in order for the relevant free-energy barriers to be crossed efficiently in the time scale of the simulation.</p>
<p>Additional information can be found in the several review papers on metadynamics <a class="el" href="citelist.html#CITEREF_gerv-laio09review">[56]</a> <a class="el" href="citelist.html#CITEREF_WCMS:WCMS31">[8]</a> <a class="el" href="citelist.html#CITEREF_WCMS:WCMS1103">[83]</a>.</p>
<p> </div> </details> </p>
<p>We will play with a toy system, alanine dipeptide simulated in vacuo using the AMBER99SB-ILDN force field (see Fig. <a class="el" href="trieste-4.html#trieste-4-ala-fig">trieste-4-ala-fig</a>). This rather simple molecule is useful to benchmark data analysis and free-energy methods. This system is a nice example because it presents two metastable states separated by a high free-energy barrier. It is conventional use to characterize the two states in terms of Ramachandran dihedral angles, which are denoted with \( \Phi \) and \( \Psi \) in Fig. <a class="el" href="trieste-4.html#trieste-4-transition-fig">trieste-4-transition-fig</a> .</p>
<p><a class="anchor" id="trieste-4-ala-fig"></a></p><div class="image">
<img src="belfast-2-ala.png" alt="belfast-2-ala.png"/>
<div class="caption">
The molecule of the day: alanine dipeptide.</div></div>
<p> <a class="anchor" id="trieste-4-transition-fig"></a></p><div class="image">
<img src="belfast-2-transition.png" alt="belfast-2-transition.png"/>
<div class="caption">
Two metastable states of alanine dipeptide are characterized by their Ramachandran dihedral angles.</div></div>
<h1><a class="anchor" id="trieste-4-ex-1"></a>
Exercise 1: my first metadynamics calculation</h1>
<h2><a class="anchor" id="trieste-4-ex-1a"></a>
Exercise 1a: setup and run</h2>
<p>In this excercise we will setup and perform a well-tempered metadynamics run using the backbone dihedral \( \phi \) as collective variable. During the calculation, we will also monitor the behavior of the other backbone dihedral \( \psi \).</p>
<p>Here you can find a sample <code>plumed.dat</code> file that you can use as a template. Whenever you see an highlighted <span style="background-color:yellow">FILL</span> string, this is a string that you should replace.</p>
<pre class="fragment">
<span style="color:blue"># Compute the backbone dihedral angle phi, defined by atoms C-N-CA-C</span>
phi: <a href="./_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> ATOMS=<span style="background-color:yellow">__FILL__</span>
<span style="color:blue"># Compute the backbone dihedral angle psi, defined by atoms N-CA-C-N</span>
psi: <a href="./_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> ATOMS=<span style="background-color:yellow">__FILL__</span>

<span style="color:blue"># Activate well-tempered metadynamics in phi</span>
metad: <span style="background-color:yellow">__FILL__</span> ARG=<span style="background-color:yellow">__FILL__</span> ...
<span style="color:blue"># Deposit a Gaussian every 500 time steps, with initial height equal to 1.2 kJoule/mol</span>
PACE=500 HEIGHT=1.2 
<span style="color:blue"># the bias factor should be wisely chosen</span>
BIASFACTOR=<span style="background-color:yellow">__FILL__</span>
<span style="color:blue"># Gaussian width (sigma) should be chosen based on CV fluctuation in unbiased run</span>
SIGMA=<span style="background-color:yellow">__FILL__</span>
<span style="color:blue"># Gaussians will be written to file and also stored on grid</span>
FILE=HILLS GRID_MIN=-pi GRID_MAX=pi
...

<span style="color:blue"># Print both collective variables and the value of the bias potential on COLVAR file</span>
<a href="./_p_r_i_n_t.html" style="color:green">PRINT</a> ARG=<span style="background-color:yellow">__FILL__</span> FILE=COLVAR STRIDE=10
</pre><p>The syntax for the command <a class="el" href="_m_e_t_a_d.html">METAD</a> is simple. The directive is followed by a keyword ARG followed by the labels of the CVs on which the metadynamics potential will act. The keyword PACE determines the stride of Gaussian deposition in number of time steps, while the keyword HEIGHT specifies the height of the Gaussian in kJoule/mol. For each CVs, one has to specify the width of the Gaussian by using the keyword SIGMA. Gaussian will be written to the file indicated by the keyword FILE.</p>
<p>In this example, the bias potential will be stored on a grid, whose boundaries are specified by the keywords GRID_MIN and GRID_MAX. Notice that you can provide either the number of bins for every collective variable (GRID_BIN) or the desired grid spacing (GRID_SPACING). In case you provide both PLUMED will use the most conservative choice (highest number of bins) for each dimension. In case you do not provide any information about bin size (neither GRID_BIN nor GRID_SPACING) and if Gaussian width is fixed, PLUMED will use 1/5 of the Gaussian width as grid spacing. This default choice should be reasonable for most applications.</p>
<p>Once your <code>plumed.dat</code> file is complete, you can run a 10-ns long metadynamics simulations with the following command </p><pre class="fragment">&gt; gmx mdrun -s topol.tpr -nsteps 5000000 -plumed plumed.dat 
</pre><p>During the metadynamics simulation, PLUMED will create two files, named COLVAR and HILLS. The COLVAR file contains all the information specified by the PRINT command, in this case the value of the CVs every 10 steps of simulation, along with the current value of the metadynamics bias potential. We can use <code>gnuplot</code> to visualize the behavior of the CV during the simulation, as reported in the COLVAR file:</p>
<pre class="fragment">gnuplot&gt; p "COLVAR" u 1:2
</pre><p><a class="anchor" id="trieste-4-phi-fig"></a></p><div class="image">
<img src="munster-metad-phi.png" alt="munster-metad-phi.png"/>
<div class="caption">
Time evolution of the metadynamics CV during the first 2 ns of a metadynamics simulation of alanine dipeptide in vacuum.</div></div>
<p> By inspecting Figure <a class="el" href="trieste-4.html#trieste-4-phi-fig">trieste-4-phi-fig</a>, we can see that the system is initialized in one of the two metastable states of alanine dipeptide. After a while (t=0.1 ns), the system is pushed by the metadynamics bias potential to visit the other local minimum. As the simulation continues, the bias potential fills the underlying free-energy landscape, and the system is able to diffuse in the entire phase space.</p>
<p>The HILLS file contains a list of the Gaussians deposited along the simulation. If we give a look at the header of this file, we can find relevant information about its content:</p>
<pre class="fragment">#! FIELDS time phi sigma_phi height biasf
#! SET multivariate false
#! SET min_phi -pi
#! SET max_phi pi
</pre><p>The line starting with FIELDS tells us what is displayed in the various columns of the HILLS file: the simulation time, the instantaneous value of \( \phi \), the Gaussian width and height, and the biasfactor. We can use the HILLS file to visualize the decrease of the Gaussian height during the simulation, according to the well-tempered recipe:</p>
<p><a class="anchor" id="trieste-4-phihills-fig"></a></p><div class="image">
<img src="munster-metad-phihills.png" alt="munster-metad-phihills.png"/>
<div class="caption">
Time evolution of the Gaussian height.</div></div>
<p> If we look carefully at the scale of the y-axis, we will notice that in the beginning the value of the Gaussian height is higher than the initial height specified in the input file, which should be 1.2 kJoule/mol. In fact, this column reports the height of the Gaussian rescaled by the pre-factor that in well-tempered metadynamics relates the bias potential to the free energy.</p>
<h2><a class="anchor" id="trieste-4-ex-1b"></a>
Exercise 1b: estimating the free energy</h2>
<p>One can estimate the free energy as a function of the metadynamics CVs directly from the metadynamics bias potential. In order to do so, the utility <a class="el" href="sum_hills.html">sum_hills</a> should be used to sum the Gaussians deposited during the simulation and stored in the HILLS file. <br />
To calculate the free energy as a function of \( \phi \), it is sufficient to use the following command line:</p>
<pre class="fragment">plumed sum_hills --hills HILLS
</pre><p>The command above generates a file called <code>fes.dat</code> in which the free-energy surface as function of \( \phi \) is calculated on a regular grid. One can modify the default name for the free energy file, as well as the boundaries and bin size of the grid, by using the following options of <a class="el" href="sum_hills.html">sum_hills</a> :</p>
<pre class="fragment">--outfile - specify the outputfile for sumhills
--min - the lower bounds for the grid
--max - the upper bounds for the grid
--bin - the number of bins for the grid
--spacing - grid spacing, alternative to the number of bins
</pre><p>The result should look like this:</p>
<p><a class="anchor" id="trieste-4-metad-phifes-fig"></a></p><div class="image">
<img src="munster-metad-phifes.png" alt="munster-metad-phifes.png"/>
<div class="caption">
Estimate of the free energy as a function of the dihedral phi from a 10ns-long well-tempered metadynamics simulation.</div></div>
<p> To assess the convergence of a metadynamics simulation, one can calculate the estimate of the free energy as a function of simulation time. At convergence, the reconstructed profiles should be similar. The option --stride should be used to give an estimate of the free energy every N Gaussians deposited, and the option --mintozero can be used to align the profiles by setting the global minimum to zero. If we use the following command line:</p>
<pre class="fragment">plumed sum_hills --hills HILLS --stride 100 --mintozero
</pre><p>one free energy is calculated every 100 Gaussians deposited, and the global minimum is set to zero in all profiles. The resulting plot should look like the following:</p>
<p><a class="anchor" id="trieste-4-metad-phifest-fig"></a></p><div class="image">
<img src="munster-metad-phifest.png" alt="munster-metad-phifest.png"/>
<div class="caption">
Estimates of the free energy as a function of the dihedral phi calculated every 100 Gaussians deposited.</div></div>
<p> These two qualitative observations:</p><ul>
<li>the system is diffusing efficiently in the collective variable space (Figure <a class="el" href="trieste-4.html#trieste-4-phi-fig">trieste-4-phi-fig</a>)</li>
<li>the estimated free energy does not change significantly as a function of time (Figure <a class="el" href="trieste-4.html#trieste-4-metad-phifest-fig">trieste-4-metad-phifest-fig</a>)</li>
</ul>
<p>suggest that the simulation most likely converged.</p>
<dl class="section warning"><dt>Warning</dt><dd>The fact that the Gaussian height is decreasing to zero should not be used as a measure of convergence of your metadynamics simulation!</dd></dl>
<dl class="section note"><dt>Note</dt><dd>The two observations above are necessary, but qualitative conditions for convergence. A quantitative assessment of convergence can be obtained by performing an error analysis of the reconstructed free-energy profile, as explained in the last exercise</dd></dl>
<h1><a class="anchor" id="trieste-4-ex-2"></a>
Exercise 2: playing with collective variables</h1>
<p>In this exercise, we will run a well-tempered metadynamics simulation on alanine dipeptide in vacuum, this time using as CV the backbone dihedral \( \psi \). Please complete the template <code>plumed.dat</code> file used in the previous exercise to run this calculation.</p>
<p>Once your <code>plumed.dat</code> file is complete, you can run a 10-ns long metadynamics simulations with the following command </p><pre class="fragment">&gt; gmx mdrun -s topol.tpr -nsteps 5000000 -plumed plumed.dat
</pre><p>As we did in the previous exercise, we can use COLVAR to visualize the behavior of the CV during the simulation. Here we will plot at the same time the evolution of the metadynamics CV \( \psi \) and of the other dihedral \( \phi \).</p>
<pre class="fragment">gnuplot&gt; p "COLVAR" u 1:2, "" u 1:3
</pre><p><a class="anchor" id="trieste-4-metad-psi-phi-fig"></a></p><div class="image">
<img src="munster-metad-psi-phi.png" alt="munster-metad-psi-phi.png"/>
<div class="caption">
Time evolution of the dihedrals phi and psi during a 10-ns long metadynamics simulation using psi as CV.</div></div>
<p> By inspecting Figure <a class="el" href="trieste-4.html#trieste-4-metad-psi-phi-fig">trieste-4-metad-psi-phi-fig</a>, we notice that something different happened compared to the previous exercise. At first the behavior of \( \psi \) looks diffusive in the entire CV space. However, around t=1 ns, \( \psi \) seems trapped in a region of the CV space in which it was previously diffusing without problems. The reason is that the non-biased CV \( \phi \) after a while has jumped into a different local minima. Since \( \phi \) is not directly biased, one has to wait for this (slow) degree of freedom to equilibrate before the free energy along \( \psi \) can converge.</p>
<p>Try to repeat the analysis done in the previous exercise, i.e. calculate the estimate of the free energy as a function of time, first step to assess the convergence of this metadynamics simulation.</p>
<h1><a class="anchor" id="trieste-4-ex-3"></a>
Exercise 3: estimating the error in free-energies using block-analysis</h1>
<p>In this exercise, we will calculate the error associated to the free-energy reconstructed by a well-tempered metadynamics simulation. The free energy and the errors will be calculated using the block-analysis technique explained in a previous lesson (<a class="el" href="trieste-2.html">Trieste tutorial: Averaging, histograms and block analysis</a>). The procedure can be used to estimate the error in the free-energy as a function of the collective variable(s) used in the metadynamics simulation, or for any other function of the coordinates of the system.</p>
<p>First, we will calculate the "unbiasing" weights associated to each conformation sampled during the metadynamics run. In order to calculate these weights, we can use either of these two approaches:</p>
<p>1) Weights are calculated by considering the time-dependence of the metadynamics bias potential <a class="el" href="citelist.html#CITEREF_Tiwary_jp504920s">[85]</a>;</p>
<p>2) Weights are calculated using the metadynamics bias potential obtained at the end of the simulation and assuming a constant bias during the entire course of the simulation <a class="el" href="citelist.html#CITEREF_Branduardi:2012dl">[22]</a>.</p>
<p>In this exercise we will use the umbrella-sampling-like reweighting approach (Method 2).</p>
<p>To calculate the weights, we need to use the PLUMED <a class="el" href="driver.html">driver</a> utility and read the HILLS file along with the GROMACS trajectory file produced during the metadynamics simulation. Let's consider the metadynamics simulation carried out in Exercise 1. We need to prepare the <code>plumed.dat</code> input file to use in combination with <a class="el" href="driver.html">driver</a>. Here you can find a sample <code>plumed.dat</code> file that you can use as a template. Whenever you see an highlighted <span style="background-color:yellow">FILL</span> string, this is a string that you should replace.</p>
<pre class="fragment">
<span style="color:blue"># Read old Gaussians deposited on HILLS file</span>
<a href="./_r_e_s_t_a_r_t.html" style="color:green">RESTART</a>
<span style="color:blue"># Compute the backbone dihedral angle phi, defined by atoms C-N-CA-C</span>
phi: <a href="./_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> ATOMS=<span style="background-color:yellow">__FILL__</span>
<span style="color:blue"># Compute the backbone dihedral angle psi, defined by atoms N-CA-C-N</span>
psi: <a href="./_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> ATOMS=<span style="background-color:yellow">__FILL__</span>

<span style="color:blue"># Activate well-tempered metadynamics in phi</span>
metad: <span style="background-color:yellow">__FILL__</span> ARG=<span style="background-color:yellow">__FILL__</span> ...
<span style="color:blue"># Set the deposition stride to a large number </span>
PACE=10000000 HEIGHT=1.2 BIASFACTOR=<span style="background-color:yellow">__FILL__</span>
<span style="color:blue"># Gaussian width (sigma) should be chosen based on CV fluctuation in unbiased run</span>
SIGMA=<span style="background-color:yellow">__FILL__</span>
<span style="color:blue"># Gaussians will be read from file and stored on grid</span>
FILE=HILLS GRID_MIN=-pi GRID_MAX=pi
...

<span style="color:blue"># Print both collective variables and the value of the bias potential on COLVAR file</span>
<a href="./_p_r_i_n_t.html" style="color:green">PRINT</a> ARG=<span style="background-color:yellow">__FILL__</span> FILE=COLVAR STRIDE=1
</pre><p>Once your <code>plumed.dat</code> file is complete, you can use the <a class="el" href="driver.html">driver</a> utility to back-calculated the quantites needed for the error calculation </p><pre class="fragment">plumed driver --plumed plumed.dat --mf_xtc traj_comp.xtc
</pre><p>The COLVAR file produced by <a class="el" href="driver.html">driver</a> should look like this:</p>
<pre class="fragment">#! FIELDS time phi psi metad.bias
#! SET min_phi -pi
#! SET max_phi pi
#! SET min_psi -pi
#! SET max_psi pi
 0.000000 0.907347 -0.144312 103.117323
 1.000000 0.814296 -0.445819 100.974351
 2.000000 1.118951 -0.909782 104.329630
 3.000000 1.040781 -0.991788 104.559590
 4.000000 1.218571 -1.020024 102.744053
</pre><p>Please check your <code>plumed.dat</code> file if your output looks different! Once the final bias has been evaluated on the entire metadynamics simulations, we can easily calculate the "unbiasing weights" using the umbrella-sampling-like approach:</p>
<pre class="fragment"># find maximum value of bias
bmax=`awk 'BEGIN{max=0.}{if($1!="#!" &amp;&amp; $4&gt;max)max=$4}END{print max}' COLVAR`

# print phi values and weights
awk '{if($1!="#!") print $2,exp(($4-bmax)/kbt)}' kbt=2.494339 bmax=$bmax COLVAR &gt; phi.weight
</pre><p>If you inspect the <code>phi.weight</code> file, you will see that each line contains the value of the dihedral \( \phi \) along with the corresponding weight:</p>
<pre class="fragment">0.907347 0.0400579
0.814296 0.0169656
1.118951 0.0651276
1.040781 0.0714174
1.218571 0.0344903
1.090823 0.0700568
1.130800 0.0622998
</pre><p> <br />
 At this point we can apply the block-analysis technique we have learned in the <a class="el" href="trieste-2.html">Trieste tutorial: Averaging, histograms and block analysis</a> tutorial to calculate for different block sizes the average free-energy and the error. For your convenience, you can use the <code>do_block_fes.py</code> python script to read the <code>phi.weight</code> file and produce the desired output. We use a bash loop to use block sizes ranging from 1 to 1000:</p>
<pre class="fragment">for i in `seq 1 10 1000`; do python3 do_block_fes.py phi.weight 1 -3.141593 3.018393 51 2.494339 $i; done
</pre><p>For each value of block length <code>N</code>, you will obtain a separate <code>fes.N.dat</code> file, containing the value of the \( \phi \) variable on a grid, the average free-energy, and the associated error (in Kjoule/mol):</p>
<pre class="fragment">   -3.141593       23.184653     0.080659
   -3.018393       17.264462     0.055181
   -2.895194       13.360259     0.047751
   -2.771994       10.772696     0.043548
   -2.648794        9.403544     0.042022
</pre><p>Finally, we can calculate the average error along the free-energy profile as a function of the block length:</p>
<pre class="fragment">for i in `seq 1 10 1000`; do a=`awk '{tot+=$3}END{print tot/NR}' fes.$i.dat`; echo $i $a; done &gt; err.blocks
</pre><p>and visualize it using <code>gnuplot</code>:</p>
<pre class="fragment">gnuplot&gt; p "err.blocks" u 1:2 w lp
</pre><p>As expected, the error increases with the block length until it reaches a plateau in correspondence of a dimension of the block that exceeds the correlation between data points (Fig. <a class="el" href="trieste-4.html#trieste-4-block-phi">trieste-4-block-phi</a>).</p>
<p><a class="anchor" id="trieste-4-block-phi"></a></p><div class="image">
<img src="trieste-4-block-phi.png" alt="trieste-4-block-phi.png"/>
<div class="caption">
Block analysis of a metadynamics simulation using phi as CV</div></div>
<p> To complete this exercise, you should do the following:</p><ul>
<li>calculate the error associated to the free energy as a function of the collective variable \( \psi \) from Exercise 1</li>
<li>calculate the error associated to the free energy as a function of the collective variable \( \psi \) from Exercise 2</li>
<li>compare the different behaviors in Exercise 1 and 2</li>
</ul>
<p>What can we learn from this analysis about the convergence of the two metadynamics simulations and the quality of the collective variables chosen?</p>
<p>At this time, the most important question of this lecture becomes:</p>
<ul>
<li>Could we distinguish the different behavior (in terms of convergence) of the simulations in Exercise 1 and 2 simply by looking at the time series of the Gaussian height?</li>
</ul>
<h1><a class="anchor" id="trieste-4-conclusions"></a>
Conclusions</h1>
<p>In summary, in this tutorial you should have learned how to use PLUMED to:</p><ul>
<li>Setup and run a metadynamics calculation.</li>
<li>Compute free energies from the metadynamics bias potential using the <a class="el" href="sum_hills.html">sum_hills</a> utility.</li>
<li>Calculate the error in the reconstructed free energy using block analysis.</li>
<li>Discriminate between good and bad collective variables.</li>
<li>Evaluate the convergence of a metadynamics simulation. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
