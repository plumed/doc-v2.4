<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>PLUMED: Trieste tutorial: Running and analyzing multi-replica simulations.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.4.8</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('trieste-5.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Trieste tutorial: Running and analyzing multi-replica simulations. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="trieste-5-aims"></a>
Aims</h1>
<p>The aim of this tutorial is to show how to use PLUMED to run simulations with multiple replicas and how to analyze them. In particular, we will focus on cases where the replicas feel different biasing potentials.</p>
<h1><a class="anchor" id="trieste-5-lo"></a>
Objectives</h1>
<p>Once this tutorial is completed students will be able to:</p>
<ul>
<li>Write plumed input files suitable for multi-replica simulations.</li>
<li>Run replica exchange simulations with gromacs and plumed using different bias potentials in each replica.</li>
<li>Analyze replica exchange simulations using WHAM so as to obtain the weight of each snapshot.</li>
</ul>
<h1><a class="anchor" id="trieste-5-resources"></a>
Resources</h1>
<p>The <span style="background-color:yellow"><a href="tutorial-resources/trieste-5.tar.gz" style="font-weight:bold" style="color:green" download="trieste-5.tar.gz">TARBALL </a> </span> for this project contains the following files:</p><ul>
<li><code>topol0.tpr</code>, <code>topol1.tpr</code>, <code>topol2.tpr</code>, and <code>topol3.tpr</code>, gromacs input files for analine dipeptide. Notice that two of them (0 and 2) are initialized in one free-energy well and two of them (1 and 3) in the other free-energy well.</li>
<li>A directory SCRIPT that contains a <code>wham.py</code> script to perform WHAM. Notice that this required python 3 (does not work with python 2).</li>
<li>A directory SETUP with the gromacs input file that can be used to generate new tpr files.</li>
</ul>
<p>This tutorial has been tested on a pre-release version of version 2.4. In particular, it takes advantage of a special syntax for setting up multi-replica simulations that is only available since version 2.4. Exercise could be done also with version 2.3 but using a different syntax with respect to the one suggested.</p>
<p>Also notice that in the <code>.solutions</code> directory of the tarball you will find correct input files. Please only look at these files after you have tried to solve the problems yourself.</p>
<h1><a class="anchor" id="trieste-5-introduction"></a>
Introduction</h1>
<p>So far we always used PLUMED to run one simulation at a time. However, PLUMED can also be used in multi-replica algorithms. When coupled with GROMACS (at least) it is also possible to run replica exchange simulations, where coordinates are swapped from time to time. In this case, PLUMED is going to take into account the different bias potentials applied to different replicas so as to compute correctly the acceptance.</p>
<p>Similarly to what we did before, we will first use the <a class="el" href="driver.html">driver</a> to understand how to prepare multi-replica input files. However, the very same holds when you run multi-replica MD simulations with MD codes that support them. For instance, in GROMACS that would be using the <code>-multi</code> option of <code>mdrun</code>.</p>
<p>Notice that this tutorial was tested using a pre-release version of PLUMED 2.4. In particular, we will use a special syntax for multi-replica input that is only available starting with PLUMED 2.4.</p>
<h1><a class="anchor" id="trieste-5-replicas"></a>
Multi replica input files</h1>
<p>Imagine that you are in a directory with these files </p><pre class="fragment">traj.0.xtc
traj.1.xtc
traj.2.xtc
plumed.dat
</pre><p> That is: three trajectories and a PLUMED input files. Let's say that the content of <code>plumed.dat</code> is </p><pre class="fragment">
d: <a href="./_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> ATOMS=1,2
<a href="./_p_r_i_n_t.html" style="color:green">PRINT</a> ARG=d FILE=COLVAR
</pre><p>You can use the following command to process the three trajectories simultaneously: </p><pre class="fragment">mpirun -np 3 plumed driver --multi 3 --plumed plumed.dat --mf_xtc traj.xtc
</pre><p> This command will produce three COLVAR files, namely <code>COLVAR.0</code>, <code>COLVAR.1</code>, and <code>COLVAR.2</code>.</p>
<p>How does this work?</p>
<p>You are here running three replicas of the <code>plumed</code> executable. When PLUMED opens a file for <b>writing</b> it adds a a suffix corresponding to the replica number. This is done for all the possible files written by PLUMED and allows you to distinguish the output of different replicas redirecting it to different files.</p>
<dl class="section attention"><dt>Attention</dt><dd>This is true also for input files that are opened for <b>reading</b>. However, when PLUMED does not find the input file with the replica suffix, it looks for the file without the suffix. That's why here it is sufficient to provide a single <code>plumed.dat</code> file. If by mistake you include an additional <code>plumed.0.dat</code> file in the same directory, PLUMED will use that file for replica 0 (and <code>plumed.dat</code> for replicas 1 and 2). To be precise, this is true for all the files read by PLUMED, with the exception of PDB files where the suffix is never added.</dd></dl>
<p>The last comment implies that if you need to process your trajectories with <em>different</em> input files you might do it creating files named <code>plumed.0.dat</code>, <code>plumed.1.dat</code>, and <code>plumed.2.dat</code>. This is correct, and this was the ony way to do multi-replica simulatons with different input files up to PLUMED 2.3. However, in the following we will see how to obtain the same effect with a new special command that has been introduced in PLUMED 2.4.</p>
<h1><a class="anchor" id="trieste-5-replica-special-syntax"></a>
Using special syntax for multiple replicas</h1>
<p>In many cases, we need to run multiple replicas with almost identical PLUMED files. These files might be prepared with cut-and-paste, which is very error prone, or could be set up with some smart bash or python script. Additionally, one can take advantage of the <a class="el" href="_i_n_c_l_u_d_e.html">INCLUDE</a> keyword so as to have a shared input file with common definitions and specific input files with replica-dependent keywords. However, as of PLUMED 2.4, we introduced a simpler manner to manipulate multiple replica inputs with tiny differences. Look at the following example:</p>
<pre class="fragment">
<span style="color:blue"># Compute a distance</span>
d: <a href="./_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> ATOMS=1,2

<span style="color:blue"># Apply a restraint.</span>
<a href="./_r_e_s_t_r_a_i_n_t.html" style="color:green">RESTRAINT</a> ARG=d AT=@replicas:1.0,1.1,1.2 KAPPA=1.0
<span style="color:blue"># On replica 0, this means:</span>
<span style="color:blue">#   RESTRAINT ARG=d AT=1.0 KAPPA=1.0</span>
<span style="color:blue"># On replica 1, this means:</span>
<span style="color:blue">#   RESTRAINT ARG=d AT=1.1 KAPPA=1.0</span>
<span style="color:blue"># On replica 2, this means:</span>
<span style="color:blue">#   RESTRAINT ARG=d AT=1.2 KAPPA=1.0</span>
</pre><p>If you prepare a single <code>plumed.dat</code> file like this one and feeds it to PLUMED while using 3 replicas, the 3 replicas will see the very same input except for the <code>AT</code> keyword, that sets the position of the restraint. Replica 0 will see a restraint centered at 1.0, replica 1 centered at 1.1, and replica 2 centered at 1.2.</p>
<p>The <code>@replicas:</code> keyword is not special for <a class="el" href="_r_e_s_t_r_a_i_n_t.html">RESTRAINT</a> or for the <code>AT</code> keyword. Any keyword in PLUMED can accept that syntax. For instance, the following single input file can be used to setup a bias exchange metadynamics <a class="el" href="citelist.html#CITEREF_piana">[71]</a> simulations: </p><pre class="fragment">
<span style="color:blue"># Compute distance between atoms 1 and 2</span>
d: <a href="./_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> ATOMS=1,2

<span style="color:blue"># Compute a torsional angle</span>
t: <a href="./_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> ATOMS=30,31,32,33

<span style="color:blue"># Metadynamics.</span>
<a href="./_m_e_t_a_d.html" style="color:green">METAD</a> ...
  ARG=@replicas:d,t
  HEIGHT=1.0
  PACE=100
  SIGMA=@replicas:0.1,0.3
  GRID_MIN=@replicas:0.0,-pi
  GRID_MAX=@replicas:2.0,+pi
...
<span style="color:blue"># On replica 0, this means:</span>
<span style="color:blue">#  METAD ARG=d HEIGHT=1.0 PACE=100 SIGMA=0.1 GRID_MIN=0.0 GRID_MAX=2.0</span>
<span style="color:blue"># On replica 1, this means:</span>
<span style="color:blue">#  METAD ARG=t HEIGHT=1.0 PACE=100 SIGMA=0.3 GRID_MIN=-pi GRID_MAX=+pi</span>
</pre><p>This would be a typical setup for a bias exchange simulation. Notice that even though variables <code>d</code> and <code>t</code> are both read in both replicas, <code>d</code> is only computed on replica 0 (and <code>t</code> is only computed on replica 1). This is because variables that are defined but not used are never actually calculated by PLUMED.</p>
<p>If the value that should be provided for each replica is a vector, you should use curly braces as delimiters. For instance, if the restraint acts on two variables, you can use the following input:</p>
<pre class="fragment">
<span style="color:blue"># Compute distance between atoms 1 and 2</span>
d: <a href="./_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> ATOMS=10,20

<span style="color:blue"># Compute a torsional angle</span>
t: <a href="./_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> ATOMS=30,31,32,33

<span style="color:blue"># Apply a restraint:</span>
<a href="./_r_e_s_t_r_a_i_n_t.html" style="color:green">RESTRAINT</a> ...
  ARG=d,t
  AT=@replicas:{{1.0,2.0} {3.0,4.0} {5.0,6.0}}
  KAPPA=1.0,3.0
...
<span style="color:blue"># On replica 0 this means:</span>
<span style="color:blue">#  RESTRAINT ARG=d AT=1.0,2.0 KAPPA=1.0,3.0</span>
<span style="color:blue"># On replica 1 this means:</span>
<span style="color:blue">#  RESTRAINT ARG=d AT=3.0,4.0 KAPPA=1.0,3.0</span>
<span style="color:blue"># On replica 2 this means:</span>
<span style="color:blue">#  RESTRAINT ARG=d AT=5.0,6.0 KAPPA=1.0,3.0</span>
</pre><p>Notice the double curly braces. The outer ones are used by PLUMED to know there the argument of the <code>AT</code> keyword ends, whereas the inner ones are used to group the values corresponding to each replica. Also notice that the last example can be split in multiple lines exploiting the fact that within multi-line statements (enclosed by pairs of <code>...</code>) newlines are replaced with simple spaces: </p><pre class="fragment">
d: <a href="./_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> ATOMS=10,20
t: <a href="./_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> ATOMS=30,31,32,33
<a href="./_r_e_s_t_r_a_i_n_t.html" style="color:green">RESTRAINT</a> ...
  ARG=d,t
<span style="color:blue"># indentation is not required (this is not python!)</span>
<span style="color:blue"># but makes the input easier to read</span>
  AT=@replicas:{
    {1.0,2.0}
    {3.0,4.0}
    {5.0,6.0}
  }
  KAPPA=1.0
...
</pre><p>In short, whenever there are keywords that should vary across replicas, you should set them usign the <code>@replicas:</code> keyword. As mentioned above, you can always use the old syntax with separate input file, and this is recommended when the number of keywords that are different is large.</p>
<h1><a class="anchor" id="trieste-5-ex-1"></a>
Exercise 1: Running multi-replica simulations</h1>
<p>Write a plumed file that allows you to run a multi-replica simulation of alanine dipeptide where the following four replicas are simulated:</p>
<ul>
<li>Two replicas with no bias potential.</li>
<li>A replica with metadynamics on \(\phi\).</li>
<li>A replica with metadynamics on \(\psi\).</li>
</ul>
<p>With PLUMED 2.3 you should use four <code>plumed.dat</code> files (named <code>plumed.0.dat</code>, <code>plumed.1.dat</code>, etc). In this case, the first two replicas feel no potential, so you could just use empty files. For the third and fourth replica you could recycle the files from <a class="el" href="trieste-4.html">Trieste tutorial: Metadynamics simulations with PLUMED</a>.</p>
<p>However, we recommend you to take the occasion to make practice with the special replica syntax of PLUMED 2.4. Use the following input file as a starting point </p><pre class="fragment">
<span style="color:blue"># load the pdb to better select torsions later</span>
<a href="./_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <span style="background-color:yellow">__FILL__</span>
<span style="color:blue"># Compute the backbone dihedral angle phi, defined by atoms C-N-CA-C</span>
phi: <a href="./_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> ATOMS=<span style="background-color:yellow">__FILL__</span>
<span style="color:blue"># Compute the backbone dihedral angle psi, defined by atoms N-CA-C-N</span>
psi: <a href="./_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> ATOMS=<span style="background-color:yellow">__FILL__</span>

metad: <a href="./_m_e_t_a_d.html" style="color:green">METAD</a> ...
<span style="color:blue"># Activate well-tempered metadynamics</span>
<span style="color:blue"># Deposit a Gaussian every 500 time steps, with initial height equal</span>
<span style="color:blue"># to 1.2 kJoule/mol, biasfactor equal to 10.0</span>
<span style="color:blue"># Remember: replica 0 and 1: no bias</span>
<span style="color:blue"># replica 2, bias on phi</span>
<span style="color:blue"># replica 3, bias on psi</span>
  ARG=<span style="background-color:yellow">__FILL__</span>
  HEIGHT=<span style="background-color:yellow">__FILL__</span> <span style="color:blue"># make sure that replicas 0 and 1 feel no potential!</span>
  PACE=500
  BIASFACTOR=10.0
  SIGMA=0.35
<span style="color:blue"># Gaussians will be written to file and also stored on grid</span>
  FILE=HILLS GRID_MIN=-pi GRID_MAX=pi
...

<span style="color:blue"># Print both collective variables and the value of the bias potential on COLVAR file</span>
<a href="./_p_r_i_n_t.html" style="color:green">PRINT</a> ARG=<span style="background-color:yellow">__FILL__</span> FILE=COLVAR STRIDE=10
</pre><p>Now check the resources provided with this tutorial. There are 4 <code>tpr</code> files available (<code>topol0.tpr</code>, <code>topol1.tpr</code>, <code>topol2.tpr</code>, and <code>topol3.tpr</code>). You can run a replica exchange simulation with gromacs using the following command </p><pre class="fragment">&gt; mpirun -np 4 gmx_mpi mdrun -plumed plumed.dat -nsteps 1000000 -replex 120 -multi 4
</pre><p> Notice that coordinates swaps will be attempted between different replicas every 120 steps. When computing the acceptance, gromacs will take into account that different replicas might be subject to different bias potential. In this example, replicas 0 and 1 are actually subject to the same potential, so all the exchanges will be accepted. You can verify this using the command</p>
<pre class="fragment">&gt; grep "Repl ex" md0.log
</pre><p>It is interesting to see what happens at different stages of the simulation. At the beginning of the trajectory you should see something like this </p><pre class="fragment">&gt; grep "Repl ex" md0.log | head
Repl ex  0 x  1    2 x  3
Repl ex  0    1 x  2    3
Repl ex  0 x  1    2 x  3
Repl ex  0    1 x  2    3
Repl ex  0 x  1    2 x  3
Repl ex  0    1    2    3
Repl ex  0 x  1    2 x  3
Repl ex  0    1 x  2    3
Repl ex  0 x  1    2 x  3
Repl ex  0    1 x  2    3
</pre><p> Notice that all the exchanges between replicas 0 and 1 are accepted and also almost all the exchanges between replicas 1, 2, and 3. At a later stage you will more likely find something like this </p><pre class="fragment">&gt; grep "Repl ex" md0.log | tail
Repl ex  0    1 x  2    3
Repl ex  0 x  1    2    3
Repl ex  0    1 x  2    3
Repl ex  0 x  1    2    3
Repl ex  0    1 x  2    3
Repl ex  0 x  1    2 x  3
Repl ex  0    1 x  2    3
Repl ex  0 x  1    2 x  3
Repl ex  0    1    2    3
Repl ex  0 x  1    2    3
</pre><p> Notice that all the exchanges between replicas 0 and 1 are still accepted. This is because the potential energy felt by replicas 0 and 1 are identical. However, exchanges between replicas 1, 2, and 3 are sometime rejected.</p>
<dl class="section note"><dt>Note</dt><dd>The setup above is very close to the one used in bias exchange simulations. However, in bias exchange simulations usually one would use at most one neutral (non-biased) replica. In addition, the <a class="el" href="_r_a_n_d_o_m__e_x_c_h_a_n_g_e_s.html">RANDOM_EXCHANGES</a> command is often used.</dd></dl>
<h1><a class="anchor" id="trieste-5-ex-2"></a>
Exercise 2: Analyzing a multiple-restraint simulation</h1>
<p>In the following we will analyze the result of the simulation above. To this aim we will have to use the WHAM method. The WHAM procedure described here is binless and allows one to reweight arbitrary bias potentials without the need to discretize collective variables. As a first step it is necessary to create a concatenated trajectory that includes all the conformations that you produced during your simulations.</p>
<pre class="fragment">&gt; gmx_mpi trjcat -f traj_comp*.xtc -cat -o fulltraj.xtc
</pre><p>Notice that a new trajectory file <code>fulltraj.xtc</code> will be in your working directory now, approximately four times bigger than the individual files <code>traj_comp*.xtc</code>.</p>
<p>Now we will process that directory computing the bias potentials associated with the replicas that we simulated. Similarly to what we did in <a class="el" href="trieste-4.html">Trieste tutorial: Metadynamics simulations with PLUMED</a>, we will assume that reweighting is done with final bias potential <a class="el" href="citelist.html#CITEREF_Branduardi:2012dl">[22]</a>. Notice that also here it would be possible to use <a class="el" href="citelist.html#CITEREF_Tiwary_jp504920s">[85]</a> instead.</p>
<pre class="fragment">
<span style="color:blue"># this will be file plumed_reweight.dat</span>
<span style="color:blue"># include here exactly the same file you used to run the simulation</span>
<span style="color:blue"># however, you should make some change to METAD:</span>
<span style="color:blue"># - replace PACE with a huge number</span>
<span style="color:blue"># - add TEMP=300 to set the temperature of the simulation</span>
<span style="color:blue"># (normally this is inherited from the MD code, but driver has no idea about it)</span>
<span style="color:blue"># - add RESTART=YES to trigger restart</span>
<span style="background-color:yellow">__FILL__</span>
<span style="background-color:yellow">__FILL__</span>
<span style="background-color:yellow">__FILL__</span>
<span style="background-color:yellow">__FILL__</span>
<span style="color:blue"># you should also change the PRINT command so as not to overwrite</span>
<span style="color:blue"># the files you wrote before.</span>
<span style="color:blue"># here omit STRIDE, so that you will print</span>
<span style="color:blue"># for all the frames in your concatenated trajectory</span>
<a href="./_p_r_i_n_t.html" style="color:green">PRINT</a> ARG=phi,psi FILE=COLVAR_CONCAT

<span style="color:blue"># Then write the bias potential (as we did for reweighting)</span>
<span style="color:blue"># As a good practice, remember that there might be multiple bias</span>
<span style="color:blue"># potential applied (e.g. METAD and a RESTRAINT).</span>
<span style="color:blue"># to be sure that you include all of them, just combine them:</span>
bias: <a href="./_c_o_m_b_i_n_e.html" style="color:green">COMBINE</a> ARG=*.bias PERIODIC=NO
<span style="color:blue"># here omit STRIDE, so that you will print the bias</span>
<span style="color:blue"># for all the frames in your concatenated trajectory</span>
<a href="./_p_r_i_n_t.html" style="color:green">PRINT</a> FILE=COLVAR_WHAM ARG=bias
</pre><p>Then analyze the concatenated trajectory with this command </p><pre class="fragment">&gt; mpirun -np 4 plumed driver --mf_xtc fulltraj.xtc --plumed plumed_reweight.dat --multi 4
</pre><p>Notice that since <code>fulltraj.xtc</code> the four concurrent copies of PLUMED will all analyze the same trajectory, which is what we want to do now. The result will be a number of COLVAR_WHAM files, one per replica, with a number of lines corresponding to the whole concatenated trajectory.</p>
<pre class="fragment"># put the bias columns in a single file ALLBIAS
&gt; paste COLVAR_WHAM.* | grep -v \# | awk '{for(i=1;i&lt;=NF/2;i++) printf($(i*2)"  ");printf("\n");}' &gt; ALLBIAS
</pre><p>Have a look at <code>ALLBIAS</code>. It should look more or less like this </p><pre class="fragment">0.000000  0.000000  75.453800  68.172206  
0.000000  0.000000  74.973726  68.143015  
0.000000  0.000000  66.948910  56.295899  
0.000000  0.000000  70.383309  60.164381  
0.000000  0.000000  65.595489  61.754951  
0.000000  0.000000  67.689166  60.869430  
</pre><p> The first two columns correspond to the bias felt in replicas 0 and 1, that are unbiased, and thus should be zero. In the other replicas on the other hand we will have large potentials accumulated by metadynamics. The actual numbers might very depending on the length of your simulation.</p>
<p>Now you can use the provided python script to analyze the <code>ALLBIAS</code> file. <code>SCRIPTS/wham.py</code> should be provided three arguments: name of the file with bias potentials, number of replicas (that is the number of columns) and value of kbT (2.5 in kj/mol).</p>
<pre class="fragment"># use the python script to compute weights
&gt; python3 SCRIPTS/wham.py ALLBIAS 4 2.5
</pre><p>This will generate a file named <code>weights.dat</code> that contains the weights for each of the frame. The initial values reported in the file should be similar to these ones: </p><pre class="fragment">&gt; head weights.dat
 3.688530731178e-05
3.899877363004e-05
7.861996862568e-07
3.663355487180e-06
1.647251040152e-06
2.689614526429e-06
3.254124396415e-06
1.511057459698e-05
2.342149322226e-05
5.032261109943e-06
</pre><p> Weights are very small since we have a long trajectory with many frames. You can check that they are normalized using the command &lsquo;awk &rsquo;{a+=$1}END{print a}' weights.dat`.</p>
<p>Now have a look at the weights. Remember that we are concatenating trajectories.</p>
<div class="image">
<img src="trieste-5-weights.png" alt="trieste-5-weights.png"/>
<div class="caption">
Weights obtained from WHAM, in logarithmic scale</div></div>
<p> Can you understand why weights in the first half are systematically different from weights in the second half? The first part correspond to the unbiased trajectories. All the snapshots sampled here are reasonably correct. However, in the second part we have heavily biased snapshots, which also sample transition states. Those points are assigned a low weight by WHAM so that they would be discarded in the calculation of any unbiased average.</p>
<p>Now we have the weight for each frame. We would like to compute the relative stability of the two free-energy wells that correspond roughly to positive and negative \(\phi\). </p><pre class="fragment">&gt; paste &lt;(grep -v \# COLVAR_CONCAT.0) weights.dat | awk '{if($2&gt;0)wb+=$NF; else wa+=$NF}END{print wa,wb}'
</pre><p> This will tell you the unbiased population of the two minima. You should expect values close to these ones </p><pre class="fragment">0.968885 0.0311148
</pre><p> that tells you that the first minimum has a population of roughly 97%.</p>
<dl class="section note"><dt>Note</dt><dd>This approach can be used to reweight any replica exchange simulation, irrespectively of how different were the employed bias potentials. This includes bias-exchange metadynamics <a class="el" href="citelist.html#CITEREF_piana">[71]</a> when using well-tempered metadynamics <a class="el" href="citelist.html#CITEREF_Barducci:2008">[7]</a>. Notice that for non-well-tempered bias exchange metadynamics one can use a very similar approach based on binning that is described in <a class="el" href="citelist.html#CITEREF_marinelli-trpc09">[66]</a>. In addition, the approach illustrated here can be used direcly in bias-exchange metadynamics simulations with additional restraints which are different in different replicas (as in <a class="el" href="citelist.html#CITEREF_cunha2017unraveling">[35]</a>) as well as other flavors of biased replica exchange simulations (e.g. <a class="el" href="citelist.html#CITEREF_curuksu2009enhanced">[36]</a> <a class="el" href="citelist.html#CITEREF_gil2015enhanced">[45]</a>). With some modification to take into account the force field energy it can be used to analyze parallel tempering simulations <a class="el" href="citelist.html#CITEREF_sugi-okam99cpl">[81]</a> and simulated tempering simulations <a class="el" href="citelist.html#CITEREF_wang2011replica">[94]</a> (notice that they can be implemented with PLUMED + GROMACS using <a class="el" href="citelist.html#CITEREF_bussi2013mp">[24]</a>).</dd></dl>
<h1><a class="anchor" id="trieste-5-ex-3"></a>
Exercise 3: What if a variable is missing?</h1>
<p>Repeat the exercise above (that is: running replica exchange MD simulation and analyze the result) but using only three replicas:</p><ul>
<li>two unbiased replicas.</li>
<li>one biased replica along psi.</li>
</ul>
<p>Create a file <code>plumed3.dat</code> aimed at this. If you are not able you can find a working one in the <code>solutions</code> directory. Then use the following commands similarly to before: </p><pre class="fragment">&gt; mpirun -np 3 gmx_mpi mdrun -plumed plumed3.dat -nsteps 1000000 -replex 120 -multi 3
&gt; gmx_mpi trjcat -f traj_comp{0,1,2}.xtc -cat -o fulltraj.xtc
&gt; mpirun -np 3 plumed driver --mf_xtc fulltraj.xtc --plumed plumed3_reweight.dat --multi 3
&gt; paste COLVAR_WHAM.{0,1,2} | grep -v \# | awk '{for(i=1;i&lt;=NF/2;i++) printf($(i*2)"  ");printf("\n");}' &gt; ALLBIAS
&gt; python3 SCRIPTS/wham.py ALLBIAS 3 2.5
</pre><p>Compute as before the relative population of the two minima. </p><pre class="fragment">&gt; paste &lt;(grep -v \# COLVAR_CONCAT.0) weights.dat | awk '{if($2&gt;0)wb+=$NF; else wa+=$NF}END{print wa,wb}'
</pre><p> Which is the result? What can you learn from this example?</p>
<p>If you did things correclty, here you should find a population close to 2/3 for the first minimum and 1/3 for the second one. Notice that this population just reflects the way we initialized the simulations (2 of them in one minimum and 1 in the other minimum) and does not take into account which is the relative stability of the two minima according to the real potential energy function. In other words, we are just obtaining the relative population that we used to initialize the simulation.</p>
<p>Also plot the colvar files and look at them with attention. An excerpt is shown below.</p>
<div class="image">
<img src="trieste-5-colvars.png" alt="trieste-5-colvars.png"/>
<div class="caption">
Time series of phi from the simulations with a missing variable (exercise 3). Notice that there are appaernt transitions, but they are</div></div>
<p> always due to accepted exchanges between replicas."</p>
<p>How many transitions between the two free-energy wells can you observe? Remember that replica exchange involves coordinate swaps that do not correspond to the real system dynamics. It is very useful to look at "demuxed" trajectories.</p>
<h1><a class="anchor" id="trieste-5-ex-4"></a>
Exercise 4: "demuxing" your trajectories</h1>
<p>Use the following commands</p>
<pre class="fragment">&gt; demux.pl md0.log
</pre><p>This will produce two files: <code>replica_index.xvg</code> and <code>replica_temp.xvg</code>. The former allows to convert your trajectories to continuous ones with the following commands</p>
<pre class="fragment">&gt; demux.pl md0.log
&gt; gmx_mpi  trjcat -f traj_comp?.xtc -demux replica_index.xvg
</pre><p>You will now find new trajectories <code>0_trajout.xtc</code>, <code>1_trajout.xtc</code>, <code>2_trajout.xtc</code>, and <code>3_trajout.xtc</code>. These files can be in turn analyzed with <code>plumed driver</code>. Try to recompute collective variables on the trajectories obtained in <a class="el" href="trieste-5.html#trieste-5-ex-1">Exercise 1: Running multi-replica simulations</a> and with those obtained in <a class="el" href="trieste-5.html#trieste-5-ex-3">Exercise 3: What if a variable is missing?</a>.</p>
<div class="image">
<img src="trieste-5-demux-good.png" alt="trieste-5-demux-good.png"/>
<div class="caption">
Time series of phi obtained from the demuxed trajectories from exercise 2</div></div>
<div class="image">
<img src="trieste-5-demux-bad.png" alt="trieste-5-demux-bad.png"/>
<div class="caption">
Time series of phi obtained from the demuxed trajectories from exercise 3</div></div>
<p> As you can see, the trajectories from <a class="el" href="trieste-5.html#trieste-5-ex-1">Exercise 1: Running multi-replica simulations</a> show a number of transitions. On the other hand, the trajectories from <a class="el" href="trieste-5.html#trieste-5-ex-3">Exercise 3: What if a variable is missing?</a> are stuck.</p>
<p>As a general rule, notice that there is no way to estimate correctly the relative population of two metastable states if there is not a continuous "demuxed" trajectory joining them, possibly exhibiting multiple transitions.</p>
<h1><a class="anchor" id="trieste-5-conclusion"></a>
Conclusions</h1>
<p>In summary, in this tutorial you should have learned how to use PLUMED to:</p><ul>
<li>Run multi replica simulations.</li>
<li>Analyze them using WHAM.</li>
</ul>
<p>Notice that the setup used is similar to the ones typically used in bias exchange simulations but can be easily adapted to any case where multiple replicas should be combined that feel different bias potentials. Moreover, the problematic example discussed shows that one should be careful and check if real transitions are observed during a replica exchange simulation. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
